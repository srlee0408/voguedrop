# Story 2.9: CanvasControls Generate 버튼 실제 기능 연결

## Status

Draft

## Story

**As a** 패션 콘텐츠 크리에이터,
**I want** Canvas 화면의 Generate 버튼을 클릭하여 바로 AI 영상을 생성하고,
**so that** 프롬프트 모달을 거치지 않고 직접 영상 생성을 시작할 수 있다.

## Acceptance Criteria

1. CanvasControls의 Generate 버튼이 직접 영상 생성 기능을 실행함
2. 이미지가 업로드되고 효과가 선택된 경우에만 버튼이 활성화됨
3. 버튼 클릭 시 즉시 영상 생성이 시작됨 (프롬프트 모달 열지 않음)
4. 생성 중에는 버튼이 "Generating..."으로 변경되고 비활성화됨
5. Canvas가 4개 슬롯으로 확장되어 표시됨
6. 생성된 영상이 첫 번째 빈 슬롯에 자동으로 표시됨
7. 각 슬롯에서 영상 재생/일시정지가 가능함
8. 생성 실패 시 명확한 에러 메시지가 표시됨
9. 생성 성공 시 히스토리 패널에 즉시 반영됨
10. 일일 생성 한도(100개) 초과 시 안내 메시지 표시

## Tasks / Subtasks

### Task 1: handleGenerateVideo 함수 활성화 (AC: 1, 3)
- [ ] canvas/page.tsx의 주석 처리된 handleGenerateVideo 함수 활성화
- [ ] 4개 슬롯 지원을 위해 setGeneratedVideos 로직 수정 (3개 → 4개)
- [ ] 함수를 Canvas 컴포넌트에 prop으로 전달할 준비
- [ ] uploadedImage 상태 변수 추가 (현재 없음)

### Task 2: Canvas 컴포넌트 Props 확장 (AC: 1)
- [ ] Canvas.tsx에 onGenerateClick prop 추가
- [ ] isGenerating prop 추가
- [ ] canGenerate prop 추가
- [ ] uploadedImage prop 추가
- [ ] CanvasControls에 새로운 props 전달

### Task 3: CanvasControls 버튼 동작 변경 (AC: 1, 2, 3, 4)
- [ ] onGenerateClick prop 추가 및 타입 정의
- [ ] isGenerating prop 추가
- [ ] canGenerate prop 추가 (이미지와 효과 확인용)
- [ ] Generate 버튼의 onClick을 onPromptModalOpen에서 onGenerateClick으로 변경
- [ ] 버튼 비활성화 조건 추가 (!canGenerate || isGenerating)
- [ ] 버튼 텍스트 조건부 렌더링 (isGenerating ? 'Generating...' : 'Generate')

### Task 4: Canvas 레이아웃 4슬롯 확장 (AC: 5, 6)
- [ ] useCanvas hook에서 images 배열을 4개로 확장
- [ ] Canvas.tsx의 그리드 레이아웃을 2x2로 변경
- [ ] 각 슬롯 크기 조정 및 반응형 디자인 적용
- [ ] 빈 슬롯 찾기 로직 구현

### Task 5: 비디오 재생 기능 구현 (AC: 7)
- [ ] 각 슬롯에 video 요소 추가 (image와 조건부 렌더링)
- [ ] 재생/일시정지 컨트롤 오버레이 추가
- [ ] 비디오 URL이 있을 때만 video 요소 렌더링
- [ ] 자동 재생 옵션 추가 (muted 상태로)

### Task 6: 상태 관리 및 에러 처리 (AC: 8, 9, 10)
- [ ] canvas/page.tsx에서 canGenerate 상태 계산 로직 추가
- [ ] uploadedImage 상태와 setUploadedImage 함수 구현
- [ ] 에러 메시지 표시를 위한 Toast 또는 Alert 컴포넌트 통합
- [ ] 생성 성공 시 히스토리 자동 갱신 로직 확인
- [ ] 일일 한도 체크 로직 확인

## Dev Notes

### 현재 코드 상태
[Source: 코드 검토]
- handleGenerateVideo 함수는 이미 구현되어 있으나 주석 처리됨 (canvas/page.tsx:76-144)
- CanvasControls의 Generate 버튼은 onPromptModalOpen을 호출 중 (CanvasControls.tsx:27)
- Canvas는 현재 3개 슬롯만 표시 (useCanvas.ts:11-26)
- API 엔드포인트 `/api/canvas/generate`는 이미 구현됨
- uploadedImage 상태 변수가 현재 canvas/page.tsx에 없음

### API 사양
[Source: fullstack-architecture.md#rest-api-specification]
```
POST /api/canvas/generate
Body:
{
  imageUrl: string,
  selectedEffects: string[],
  basePrompt?: string,
  modelType: 'seedance' | 'hailo'
}
Response:
{
  generationId: string,
  videoUrl: string
}
```

### 컴포넌트 구조
[Source: 현재 파일 구조]
```
app/canvas/
├── page.tsx (메인 페이지 - handleGenerateVideo 함수)
├── _components/
│   ├── Canvas.tsx (메인 캔버스 컴포넌트)
│   ├── CanvasControls.tsx (Generate 버튼 포함)
│   └── LeftPanel.tsx (이미지 업로드 포함)
└── _hooks/
    └── useCanvas.ts (캔버스 상태 관리)
```

### 기술 제약사항
- Next.js 14+ App Router 사용
- TypeScript 필수 (any 타입 금지)
- Tailwind CSS로 스타일링
- 생성 시간 30-60초 예상
- 이미지는 base64 또는 URL 형태로 전달

### 구현 참고사항
1. uploadedImage 상태가 없으므로 추가 필요
2. ImageSection 컴포넌트의 onImageUpload 콜백이 이미 구현됨
3. generatedVideos 상태는 이미 있지만 현재 빈 배열
4. isGenerating 상태는 이미 있지만 사용되지 않음
5. selectedEffects 상태는 이미 구현되어 있음

## Testing

### 테스트 요구사항
[Source: fullstack-architecture.md#testing-strategy]
- Vitest 1.2+로 단위 테스트
- @testing-library/react로 컴포넌트 테스트
- Playwright로 E2E 테스트

### 필수 테스트
1. **컴포넌트 테스트**
   - Generate 버튼 활성화/비활성화 조건
   - 클릭 이벤트 핸들러 호출 확인
   - 로딩 상태 표시

2. **통합 테스트**
   - 영상 생성 전체 플로우
   - 에러 처리 시나리오
   - 히스토리 업데이트 확인

3. **E2E 테스트**
   - 이미지 업로드 → 효과 선택 → Generate 클릭 → 영상 표시

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-31 | 1.0 | 초기 스토리 생성 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*To be populated after QA review*