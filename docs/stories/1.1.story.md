# Story 1.1: Supabase 갤러리 데이터 연동

## Story

As a VogueDrop user, I want to see real gallery items from the Supabase database when I visit the gallery section, so that I can browse actual created fashion videos instead of placeholder content.

## Status

Ready for Review

## Acceptance Criteria

1. [ ] Supabase client is properly configured and connected to the database
2. [ ] Gallery page fetches and displays creation data from Supabase with proper joins to media_assets
3. [ ] Each gallery item shows title, category name, and thumbnail image correctly
4. [ ] Loading state is displayed while fetching data
5. [ ] Error handling is implemented with user-friendly error messages
6. [ ] Environment variables are securely managed in .env.local

## Dev Notes

### Database Schema Reference
Based on the provided Supabase schema:

```sql
-- Categories table
CREATE TABLE public.categories (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Media assets table  
CREATE TABLE public.media_assets (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  storage_path text NOT NULL UNIQUE,
  file_name text,
  media_type text,
  created_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Creations table
CREATE TABLE public.creations (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  title text,
  prompt text NOT NULL,
  category_id bigint NOT NULL,
  product_id bigint NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT creations_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.media_assets(id),
  CONSTRAINT creations_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);

-- Creation media links junction table
CREATE TABLE public.creation_media_links (
  creation_id bigint NOT NULL,
  media_id bigint NOT NULL,
  CONSTRAINT creation_media_links_creation_id_fkey FOREIGN KEY (creation_id) REFERENCES public.creations(id),
  CONSTRAINT creation_media_links_media_id_fkey FOREIGN KEY (media_id) REFERENCES public.media_assets(id)
);
```

### Technical Implementation Details

**Package Requirements**:
- @supabase/supabase-js (for Supabase client)

**File Locations** (following Next.js App Router conventions):
- `/lib/supabase.ts` - Supabase client initialization
- `/types/database.ts` - TypeScript type definitions
- `/lib/api/gallery.ts` - Gallery data fetching functions
- `/components/home/GallerySection.tsx` - Update existing component
- `/.env.local` - Environment variables (to be created)

**Current Component State**:
The existing GallerySection component at `/components/home/GallerySection.tsx` is a client component that receives static data through props. It needs to be converted to fetch real data from Supabase.

### Design System Compliance
Following CLAUDE.md guidelines:
- Component-Based: Maintain GallerySection as a reusable component
- Consistency: Keep existing UI/UX patterns while integrating real data
- Responsive: Ensure data fetching doesn't break responsive grid layout

## Tasks / Subtasks

### Task 1: Setup Supabase Client and Environment (AC: 1, 5)
- [x] Install @supabase/supabase-js package
- [x] Create .env.local file with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
- [x] Create /lib/supabase.ts with client initialization
- [x] Add .env.local to .gitignore if not already present

### Task 2: Create TypeScript Type Definitions (AC: 2, 3)
- [x] Create /types/database.ts file
- [x] Define Category interface matching database schema
- [x] Define MediaAsset interface matching database schema  
- [x] Define Creation interface matching database schema
- [x] Define CreationWithMedia interface for joined data

### Task 3: Implement Gallery API Layer (AC: 2)
- [x] Create /lib/api/gallery.ts file
- [x] Implement getGalleryItems() function with proper joins
- [x] Implement getCategories() function for future filtering
- [x] Add proper error handling and type safety

### Task 4: Update GallerySection Component (AC: 2, 3, 4, 5)
- [x] Convert GallerySection to server component (remove "use client")
- [x] Replace static data props with Supabase data fetching
- [x] Implement loading state UI
- [x] Implement error state UI with fallback
- [x] Update item rendering to use real data fields
- [x] Use Next.js Image component for optimized image loading

### Task 5: Testing and Validation (AC: 1-6)
- [x] Test Supabase connection
- [x] Verify data fetching works correctly
- [x] Test error scenarios (network failure, invalid credentials)
- [x] Verify responsive layout with real data
- [x] Check TypeScript types are properly applied
- [x] Ensure no environment variables are exposed in client code

## Testing

### Manual Testing Checklist
1. Gallery page loads without errors
2. Real data appears instead of placeholders
3. Images load correctly from Supabase storage
4. Loading state appears briefly on initial load
5. Error message appears if Supabase is unreachable
6. Layout remains responsive with varying content lengths

### Unit Tests to Write
1. Test Supabase client initialization
2. Test gallery API functions return correct data shape
3. Test error handling in API layer

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [ ] Fallback: N/A 

### Debug Log References
- [x] Session: 2024-01-28 

### Completion Notes
- [x] Successfully implemented Supabase integration for gallery
- [x] All tasks completed without major blockers
- [x] Fixed linting errors
- [x] Added Next.js Image configuration for Supabase storage
- [x] Fixed HomeHeader component error by adding "use client" directive
- [x] Added getPublicUrl utility function for Supabase storage URLs
- [x] Improved error handling for missing images with fallback gradient
- [x] Added debug logging for storage paths
- [x] Created SUPABASE_SETUP.md documentation for bucket configuration
- [x] Fixed server component event handler error by separating into client component
- [x] Fixed storage URL path to use correct bucket name (media-asset) 

### File List
New/Modified files in this story:
- [x] package.json
- [x] package-lock.json  
- [x] .env.local (new)
- [x] /lib/supabase.ts (new - includes getPublicUrl utility)
- [x] /types/database.ts (new)
- [x] /lib/api/gallery.ts (new)
- [x] /components/home/GallerySection.tsx (modified - refactored for server components)
- [x] /components/home/GalleryItems.tsx (new - client component for gallery items)
- [x] /app/page.tsx (modified - removed "use client")
- [x] /next.config.ts (modified - added Supabase image domain)
- [x] /components/home/HomeHeader.tsx (modified - added "use client")
- [x] /docs/SUPABASE_SETUP.md (new - setup documentation)

### Change Log
- [x] Initial story creation
- [x] Implemented all tasks successfully
- [x] Fixed TypeScript and linting issues