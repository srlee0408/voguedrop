# Story 2.1: Canvas AI 영상 생성 - 데이터베이스 설정 및 시드 데이터

## Story

As a VogueDrop developer, I want to set up the database schema and seed data for the Canvas AI video generation feature, so that the system has the necessary data structure and example effect templates ready for video generation.

## Status

Done

## Acceptance Criteria

1. [ ] New database tables (effect_templates, video_generations) are created successfully
2. [ ] Canvas-related categories ('effect', 'camera', 'model') are added to the categories table
3. [ ] At least 3 effect templates per category are seeded with appropriate prompts
4. [ ] All database migrations run without errors
5. [ ] RLS policies are properly configured for the new tables
6. [ ] Seed data includes preview image URLs or media asset references

## Dev Notes

### Database Schema Reference
Based on the Canvas AI MVP documentation (`docs/features/canvas-ai-video-generation-mvp.md`):

**New Tables Required:**

1. **effect_templates** - Stores effect/camera/model options
   - Links to categories table via category_id
   - Contains fal.ai prompts for each effect
   - Includes preview media references

2. **video_generations** - Tracks user video generation requests
   - Simplified version for MVP (user_id as text, allows 'anonymous')
   - Stores source image URL, selected effects, and results
   - Status tracking for generation progress

**Existing Tables to Update:**
- **categories** - Add new categories for Canvas feature
- **media_assets** - Will store preview videos/images for effects

### File Locations
- Database migrations: `supabase/migrations/`
- Seed data script: `supabase/seed.sql` or create new `supabase/seeds/canvas-effects.sql`

### Technical Details

**Categories to Add:**
```sql
INSERT INTO categories (name) VALUES 
  ('effect'),   -- Visual effects like dreamy, vintage, etc.
  ('camera'),   -- Camera movements like zoom, pan, etc.
  ('model');    -- Model behaviors like walk, pose, etc.
```

**Effect Templates Examples:**
- Camera: 'Zoom In', 'Pan Left', 'Rotate'
- Effect: 'Dreamy', 'Vintage', 'Neon'
- Model: 'Fashion Walk', 'Pose Change', 'Hair Flow'

**RLS Policies:**
- effect_templates: Public read access (no authentication required)
- video_generations: Users can only access their own records (user_id based)

### Testing

**Verification Steps:**
1. Run migrations: `supabase db push`
2. Verify tables exist: Check Supabase dashboard
3. Test seed data: Query effect_templates to ensure data is present
4. Test RLS: Attempt to read effect_templates without auth

## Tasks / Subtasks

### Task 1: Create Database Migration for New Tables (AC: 1, 5)
- [x] Create migration file: `supabase/migrations/[timestamp]_add_canvas_ai_tables.sql`
- [x] Define effect_templates table schema
- [x] Define video_generations table schema
- [x] Add necessary indexes for performance
- [x] Add RLS policies in the same migration

### Task 2: Update Categories Table (AC: 2)
- [x] Create migration to insert Canvas categories
- [x] Ensure categories have unique names
- [x] Verify no conflicts with existing categories

### Task 3: Create Seed Data Script (AC: 3, 6)
- [x] Create seed file: `supabase/seeds/canvas-effect-templates.sql`
- [x] Add at least 3 camera effects with prompts
- [x] Add at least 3 visual effects with prompts
- [x] Add at least 3 model effects with prompts
- [x] Include placeholder preview URLs or create media_assets entries

### Task 4: Test Database Setup (AC: 4)
- [x] Run all migrations locally
- [x] Verify tables are created correctly
- [x] Test seed data insertion
- [x] Verify RLS policies work as expected
- [x] Document any issues or adjustments needed

### Task 5: Documentation Update
- [x] Update database documentation if exists
- [x] Create migration rollback script for safety
- [x] Document seed data structure for future additions

## Testing

### Migration Testing
- Run migrations in local Supabase instance
- Verify all tables and constraints are created
- Test rollback procedure

### Data Integrity Testing
- Verify foreign key relationships work correctly
- Test that effect_templates link properly to categories
- Ensure preview_media_id references are valid (or null)

### RLS Testing
- Test anonymous user can read effect_templates
- Test user-specific access to video_generations
- Verify security policies prevent unauthorized access

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [ ] Fallback: N/A

### Debug Log References
- [x] Session: 2025-01-30

### Completion Notes
- [x] All database migrations and seed data successfully created
- [x] Added comprehensive test script for verification
- [x] Created rollback script for safety
- [x] Documentation added for migration process
- [x] 18 effect templates created (6 per category)

### File List
Expected files to create/modify:
- [x] supabase/migrations/20250130_add_canvas_ai_tables.sql
- [x] supabase/migrations/20250130_add_canvas_categories.sql
- [x] supabase/seeds/canvas-effect-templates.sql
- [x] supabase/test-migrations.sql (additional)
- [x] supabase/migrations/README.md (additional)
- [x] supabase/rollback/rollback_canvas_ai.sql (additional)

## Change Log
- [x] Initial story creation - 2025-01-30
- [x] Story implementation completed - 2025-01-30

## QA Results

### Review Date: 2025-01-30
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
전반적으로 매우 잘 구현되었습니다. 데이터베이스 마이그레이션과 시드 데이터가 체계적으로 작성되었고, MVP 요구사항을 모두 충족합니다. 특히 롤백 스크립트와 테스트 스크립트를 추가로 작성한 것은 훌륭한 판단이었습니다.

### Refactoring Performed
- **File**: supabase/migrations/20250130_add_canvas_ai_tables.sql
  - **Change**: effect_templates 테이블에 UNIQUE constraint 추가
  - **Why**: seed 데이터의 ON CONFLICT 처리를 위해 필요
  - **How**: `CONSTRAINT unique_effect_template_per_category UNIQUE (name, category_id)` 추가로 중복 방지 및 업데이트 가능

- **File**: supabase/seeds/canvas-effect-templates.sql
  - **Change**: ON CONFLICT DO NOTHING을 ON CONFLICT DO UPDATE로 변경
  - **Why**: 시드 데이터 재실행 시 프롬프트나 순서 변경이 반영되도록
  - **How**: `ON CONFLICT (name, category_id) DO UPDATE SET prompt = EXCLUDED.prompt, display_order = EXCLUDED.display_order`

### Compliance Check
- Coding Standards: ✓ SQL 코딩 표준 준수
- Project Structure: ✓ 파일 위치가 Dev Notes 가이드와 일치
- Testing Strategy: ✓ 테스트 스크립트 제공
- All ACs Met: ✓ 모든 Acceptance Criteria 충족

### Improvements Checklist
- [x] UNIQUE constraint 추가하여 데이터 무결성 강화
- [x] 시드 데이터 재실행 가능하도록 ON CONFLICT 전략 개선
- [ ] 향후 실제 프리뷰 비디오 업로드 시 media_assets 연동 필요

### Security Review
- RLS 정책이 적절히 구성됨
- anonymous 사용자 지원으로 MVP 요구사항 충족
- 민감한 정보 노출 없음

### Performance Considerations
- 적절한 인덱스 생성 (category_id, user_id, status, created_at)
- CASCADE 옵션으로 참조 무결성 보장
- 시드 데이터가 효율적으로 구성됨

### Final Status
✓ Approved - Ready for Done

모든 요구사항이 충족되었고 코드 품질이 우수합니다. 추가로 개선한 사항들이 시스템의 안정성과 유지보수성을 향상시켰습니다.