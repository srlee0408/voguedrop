# 이미지 업로드 시스템 개선 작업 로그

**작업 일시**: 2025년 7월 31일 12:56  
**작업자**: 개발자 & Claude Code  
**작업 내용**: Canvas 이미지 업로드 방식 개선 및 UI 단순화

## 작업 개요

VogueDrop Canvas 페이지의 이미지 업로드 시스템을 전면 개선했습니다. Supabase Storage 사용을 제거하고 base64 인코딩 방식으로 변경하여 RLS 에러를 해결하고, UI를 단순화하여 사용자 경험을 개선했습니다.

## 주요 문제점 및 해결 방법

### 1. Supabase RLS 에러 문제

#### 문제 상황
```
Supabase upload error: {
  statusCode: '403',
  error: 'Unauthorized',
  message: 'new row violates row-level security policy'
}
```

#### 원인 분석
- `/api/canvas/upload` 라우트가 인증되지 않은 Supabase 클라이언트 사용
- `lib/supabase.ts`의 기본 클라이언트는 anon key만 사용하여 인증 정보 없음
- Supabase Storage의 RLS 정책이 인증된 사용자만 업로드 허용

#### 해결 방법
- Supabase Storage 사용을 완전히 제거
- 클라이언트에서 FileReader API로 이미지를 base64로 변환
- fal.ai API가 base64 data URI를 직접 지원함을 확인

### 2. 이미지 업로드 방식 변경

#### 기존 방식
```typescript
// 1. 파일을 FormData로 서버에 전송
// 2. 서버에서 Supabase Storage에 업로드
// 3. Public URL 반환
// 4. URL을 fal.ai API에 전달
```

#### 새로운 방식
```typescript
// ImageSection.tsx
const reader = new FileReader();
reader.onload = (e) => {
  const base64Url = e.target?.result as string;
  setUploadedImage(base64Url);
  onImageUpload?.(base64Url);
};
reader.readAsDataURL(file);
```

### 3. UI/UX 개선

#### 초기 요구사항 변화
1. **첫 번째 시도**: 3개 슬롯에 이미지 선택 기능
   - 문제: 선택 테두리가 초록색으로 직관적이지 않음
   
2. **두 번째 시도**: 단일 이미지 슬롯으로 단순화
   - 문제: 슬롯 크기가 너무 커짐

3. **최종 구현**: + 버튼과 이미지 슬롯 분리
   - + 버튼은 항상 표시
   - 업로드된 이미지는 별도 슬롯에 표시
   - 기존 크기(64x64px) 유지

#### 최종 UI 구조
```
Image
[+] [이미지]
```

## 기술적 구현 세부사항

### 1. 제거된 파일
- `/app/api/canvas/upload/route.ts` - 더 이상 필요 없음

### 2. 수정된 컴포넌트

#### ImageSection.tsx
```typescript
// 제거된 것들
- import { Video, X } from "lucide-react"
- generatedVideos props
- 이미지 선택 기능
- 삭제 버튼
- 여러 이미지 관리 로직

// 추가/변경된 것들
+ base64 변환 로직
+ 단순화된 UI (+ 버튼과 이미지 슬롯만)
```

#### Canvas 페이지
```typescript
// 제거
- selectedImageUrl 상태
- onImageSelect 핸들러

// 유지
+ uploadedImage 상태 (base64 URL 저장)
```

### 3. fal.ai API 호환성

fal.ai API는 다음 형식을 모두 지원:
- 일반 URL: `https://example.com/image.jpg`
- base64 data URI: `data:image/jpeg;base64,YOUR_BASE64_STRING`

## 장단점 분석

### 장점
1. **인증 문제 해결**: Supabase RLS 정책 우회
2. **단순한 구조**: API 라우트 제거로 복잡도 감소
3. **빠른 처리**: 서버 왕복 없이 즉시 처리
4. **비용 절감**: Storage 사용량 없음
5. **직관적 UI**: 단순화된 인터페이스

### 단점
1. **성능**: 대용량 이미지의 경우 base64 변환 오버헤드
2. **메모리**: 브라우저 메모리에 base64 문자열 저장
3. **네트워크**: API 요청 시 base64 데이터 전송 (원본보다 약 33% 큼)

### 성능 고려사항
- 일반적인 이미지(5-10MB)는 문제없음
- 파일 크기 제한(10MB)이 있어 극단적인 경우 방지
- 최신 브라우저는 FileReader API를 효율적으로 처리

## 교육적 포인트

### 1. Base64 인코딩
- **장점**: 텍스트로 바이너리 데이터 표현, URL safe
- **단점**: 크기 증가(약 33%), 메모리 사용
- **사용 사례**: 작은 이미지, 임시 데이터, API 통신

### 2. FileReader API
```javascript
const reader = new FileReader();
reader.readAsDataURL(file); // base64 data URI 생성
reader.readAsArrayBuffer(file); // ArrayBuffer 생성
reader.readAsText(file); // 텍스트로 읽기
```

### 3. 프론트엔드 아키텍처 결정
- **서버리스 vs 서버**: 임시 데이터는 클라이언트에서 처리
- **복잡도 vs 편의성**: 단순한 것이 최선
- **에러 처리**: 각 단계별 에러 포인트 최소화

## 사용자 피드백 반영

1. **"선택 테두리 색이 초록색이라 직관적이지 않다"**
   → 선택 기능 자체를 제거하고 단순화

2. **"하나의 슬롯만 보이도록 하고 삭제 버튼도 없애자"**
   → 최소한의 UI로 변경

3. **"슬롯 크기는 그전과 동일하게"**
   → 64x64px 크기 유지

4. **"+ 버튼은 계속 놔두고 옆에 빈 슬롯"**
   → + 버튼과 이미지 슬롯 분리

5. **"generate videos는 필요 없어"**
   → 비디오 관련 코드 모두 제거

## 향후 개선 사항

1. **이미지 압축**: 업로드 전 클라이언트에서 압축
2. **미리보기 최적화**: 썸네일용 저해상도 버전 생성
3. **드래그 앤 드롭**: 파일 업로드 UX 개선
4. **진행 표시**: 대용량 파일 변환 시 프로그레스 바

## 커밋 정보

```bash
refactor: Simplify ImageSection to single image upload slot

- Remove Supabase upload API route - use base64 directly instead
- Simplify ImageSection to show only upload button and single image slot
- Remove generatedVideos display from ImageSection
- Remove multiple image selection and delete functionality
- Fix fal.ai integration to use base64 data URIs directly
- Clean up unused state management for image selection
- Improve UX with simpler image replacement flow
```

## 참고 자료

- [MDN - FileReader API](https://developer.mozilla.org/en-US/docs/Web/API/FileReader)
- [fal.ai Documentation](https://fal.ai/docs)
- [Base64 Encoding 이해하기](https://developer.mozilla.org/en-US/docs/Glossary/Base64)

---

**작업 완료 시간**: 2025년 7월 31일 12:56