# Story 2.6: fal.ai 연동 및 영상 생성 API

## Story

**As a** VogueDrop 사용자,
**I want** 선택한 이미지와 효과로 AI 영상을 생성할 수 있고,
**so that** 커스텀 AI 영상 콘텐츠를 만들 수 있다.

## Status

Completed

## Acceptance Criteria

1. [x] Generate 버튼 클릭시 영상 생성 API가 호출됨
2. [x] fal.ai Seedance 모델을 사용하여 영상이 생성됨
3. [x] 선택된 효과들의 프롬프트가 결합되어 전달됨
4. [x] 생성 요청이 DB에 저장됨 (video_generations 테이블)
5. [x] 생성된 영상 URL이 반환되어 표시됨
6. [x] API 타임아웃(60초)이 적절히 처리됨
7. [x] 생성 실패시 에러가 DB에 기록되고 사용자에게 표시됨
8. [x] 환경변수로 API 키가 안전하게 관리됨

## Dev Notes

### fal.ai 설정 (MVP 문서 참조)
```typescript
// lib/fal-ai.ts
import * as fal from "@fal-ai/serverless-client";

// 서버사이드 전용
if (typeof window === 'undefined') {
  fal.config({
    credentials: process.env.FAL_API_KEY
  });
}

export async function generateVideo(
  imageUrl: string,
  prompt: string,
  modelType: 'seedance' | 'hailo' = 'seedance'
) {
  const model = modelType === 'seedance' 
    ? "fal-ai/fast-sdxl/image-to-video"  // 실제 모델명 확인 필요
    : "fal-ai/hailo";
    
  const result = await fal.run(model, {
    input: {
      image_url: imageUrl,
      prompt: prompt,
      num_frames: 25,
      fps: 8,
      motion_strength: 0.7
    }
  });
  
  return result.video.url;
}
```

### 영상 생성 API 엔드포인트
```typescript
// app/api/canvas/generate/route.ts
export async function POST(request: Request) {
  const body = await request.json();
  
  // 1. DB에 생성 요청 저장 (pending 상태)
  const generation = await saveGeneration(body);
  
  // 2. fal.ai 직접 호출 (30-60초 소요)
  try {
    const videoUrl = await generateWithFal(body);
    
    // 3. 성공시 DB 업데이트
    await updateGeneration(generation.id, {
      status: 'completed',
      videoUrl
    });
    
    return Response.json({ 
      success: true, 
      generationId: generation.id,
      videoUrl 
    });
    
  } catch (error) {
    // 4. 실패시 에러 처리
    await updateGeneration(generation.id, {
      status: 'failed',
      error: error.message
    });
    
    return Response.json({ 
      success: false, 
      error: '영상 생성 실패' 
    }, { status: 500 });
  }
}
```

### 데이터베이스 작업
- video_generations 테이블 사용
- 상태: pending → completed/failed
- 익명 사용자 지원 (user_id: 'anonymous')

### 환경변수
```
FAL_API_KEY=your_fal_api_key
DAILY_GENERATION_LIMIT=100
```

### Vercel 설정
- 함수 타임아웃: 60초 설정 필요
- vercel.json에 설정 추가

## Tasks / Subtasks

### Task 1: fal.ai 클라이언트 설정 (AC: 8)
- [x] @fal-ai/serverless-client 패키지 설치
- [x] lib/fal-ai.ts 파일 생성
- [x] fal.ai 초기화 및 설정
- [x] 환경변수 설정 (.env.local)

### Task 2: 영상 생성 API 엔드포인트 구현 (AC: 1, 2, 3)
- [x] app/api/canvas/generate/route.ts 생성
- [x] POST 핸들러 구현
- [x] 효과 프롬프트 결합 로직
- [x] fal.ai 호출 통합

### Task 3: 데이터베이스 연동 (AC: 4, 7)
- [x] Supabase 클라이언트 설정
- [x] video_generations 테이블 CRUD 함수
- [x] 상태 업데이트 로직
- [x] 에러 로깅 구현

### Task 4: 클라이언트 통합 (AC: 5)
- [x] Generate 버튼 이벤트 핸들러
- [x] API 호출 및 응답 처리
- [x] 생성된 영상 URL 상태 관리
- [x] ImageSection에 영상 표시

### Task 5: 타임아웃 및 에러 처리 (AC: 6, 7)
- [x] Vercel 함수 타임아웃 설정
- [x] 클라이언트 타임아웃 처리
- [x] 에러 메시지 사용자 표시
- [x] 재시도 옵션 제공

### Task 6: 테스트 및 최적화
- [x] 다양한 이미지/프롬프트 조합 테스트
- [x] 에러 시나리오 테스트
- [x] 성능 모니터링
- [x] 일일 한도 체크 로직 (선택사항)

## Testing

### 테스트 요구사항
- fal.ai API 연동 테스트
- 데이터베이스 트랜잭션 테스트
- 타임아웃 처리 테스트
- 에러 핸들링 테스트
- 환경변수 검증

### 테스트 시나리오
1. 정상적인 영상 생성 플로우
2. fal.ai API 에러 응답
3. 네트워크 타임아웃 (60초 초과)
4. 잘못된 이미지 URL 전달
5. 빈 프롬프트 처리

## Change Log
- [x] 2025-01-30: 초기 스토리 생성
- [x] 2025-01-30: 구현 완료

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [x] Fallback: N/A

### Debug Log References
- [x] Session: 2025-01-30

### Completion Notes
- [x] fal.ai 라이브러리 설정 완료
- [x] 영상 생성 API 엔드포인트 구현
- [x] 데이터베이스 연동 및 상태 관리 구현
- [x] Generate 버튼과 영상 생성 플로우 통합
- [x] Vercel 함수 타임아웃 60초 설정
- [x] 에러 처리 및 사용자 피드백 구현
- [x] seedance와 hailo 모델 모두 지원 가능하도록 구현

### File List
실제 생성/수정된 파일:
- [x] lib/fal-ai.ts (생성)
- [x] app/api/canvas/generate/route.ts (생성)
- [x] lib/db/video-generations.ts (생성)
- [x] app/canvas/_components/QuickActionsBar.tsx (수정)
- [x] app/canvas/page.tsx (영상 생성 로직 추가)
- [x] app/canvas/_components/LeftPanel.tsx (props 추가)
- [x] vercel.json (생성)
- [x] .env.local (수정)
- [x] types/canvas.ts (GeneratedVideo 타입 추가)

## QA Results
- [x] 모든 acceptance criteria 충족
- [x] 타입스크립트 컴파일 에러 없음
- [x] ESLint 경고 해결
- [x] 빌드 성공

## fal.ai API 설정 가이드

이 문서는 제공된 블루프린트를 기반으로 `fal.ai`의 비디오 생성 API를 설정하고 사용하는 방법을 안내합니다.

-----

### 🚀 API 기본 정보

두 개의 다른 AI 모델을 사용하여 이미지로부터 비디오를 생성합니다. 각 모델은 고유한 엔드포인트(URL) 주소를 가집니다.

  * **HTTP 메소드:** 모든 요청은 `POST` 방식을 사용해야 합니다.

  * **엔드포인트:**

      * **seedance 모델:** `https://fal.run/fal-ai/bytedance/seedance/v1/pro/image-to-video`
      * **hailo 모델:** `https://fal.run/fal-ai/minimax/hailuo-02/standard/image-to-video`

-----

### 🔑 인증 및 헤더 설정

API 요청 시에는 **인증**과 **콘텐츠 타입**을 명시하기 위해 아래 두 가지 헤더를 필수로 포함해야 합니다.

1.  **Authorization (인증)**

      * **Key:** `Authorization`
      * **Value:** `Key [YOUR_FAL_AI_API_KEY]`
      * **설명:** `[YOUR_FAL_AI_API_KEY]` 부분을 자신의 fal.ai API 키로 교체해야 합니다.

2.  **Content-Type (콘텐츠 타입)**

      * **Key:** `Content-Type`
      * **Value:** `application/json`

-----

### 📦 요청 본문 (Request Body) 구성

요청 본문은 **JSON 형식**으로 작성해야 합니다. 각 모델별로 필요한 파라미터가 다르니 주의 깊게 확인하시기 바랍니다.

#### 1\. seedance 모델

  * **설명:** `seedance` 모델을 사용하여 3초 길이의 1080p 해상도 영상을 생성합니다.
  * **요청 본문 예시:**
    ```json
    {
      "prompt": "여기에 프롬프트를 입력하세요",
      "resolution": "1080p",
      "duration": "3",
      "image_url": "https://your-image-url.com/image.png"
    }
    ```

#### 2\. hailo 모델

  * **설명:** `hailo` 모델을 사용하여 6초 길이의 영상을 생성하며, 프롬프트 최적화 기능이 활성화됩니다.
  * **요청 본문 예시:**
    ```json
    {
      "prompt": "여기에 프롬프트를 입력하세요",
      "image_url": "https://your-image-url.com/image.png",
      "duration": "6",
      "prompt_optimizer": true
    }
    ```