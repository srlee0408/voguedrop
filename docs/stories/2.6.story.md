# Story 2.6: fal.ai ì—°ë™ ë° ì˜ìƒ ìƒì„± API

## Story

**As a** VogueDrop ì‚¬ìš©ì,
**I want** ì„ íƒí•œ ì´ë¯¸ì§€ì™€ íš¨ê³¼ë¡œ AI ì˜ìƒì„ ìƒì„±í•  ìˆ˜ ìˆê³ ,
**so that** ì»¤ìŠ¤í…€ AI ì˜ìƒ ì½˜í…ì¸ ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

## Status

Completed

## Acceptance Criteria

1. [x] Generate ë²„íŠ¼ í´ë¦­ì‹œ ì˜ìƒ ìƒì„± APIê°€ í˜¸ì¶œë¨
2. [x] fal.ai Seedance ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì˜ìƒì´ ìƒì„±ë¨
3. [x] ì„ íƒëœ íš¨ê³¼ë“¤ì˜ í”„ë¡¬í”„íŠ¸ê°€ ê²°í•©ë˜ì–´ ì „ë‹¬ë¨
4. [x] ìƒì„± ìš”ì²­ì´ DBì— ì €ì¥ë¨ (video_generations í…Œì´ë¸”)
5. [x] ìƒì„±ëœ ì˜ìƒ URLì´ ë°˜í™˜ë˜ì–´ í‘œì‹œë¨
6. [x] API íƒ€ì„ì•„ì›ƒ(60ì´ˆ)ì´ ì ì ˆíˆ ì²˜ë¦¬ë¨
7. [x] ìƒì„± ì‹¤íŒ¨ì‹œ ì—ëŸ¬ê°€ DBì— ê¸°ë¡ë˜ê³  ì‚¬ìš©ìì—ê²Œ í‘œì‹œë¨
8. [x] í™˜ê²½ë³€ìˆ˜ë¡œ API í‚¤ê°€ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë¨

## Dev Notes

### fal.ai ì„¤ì • (MVP ë¬¸ì„œ ì°¸ì¡°)
```typescript
// lib/fal-ai.ts
import * as fal from "@fal-ai/serverless-client";

// ì„œë²„ì‚¬ì´ë“œ ì „ìš©
if (typeof window === 'undefined') {
  fal.config({
    credentials: process.env.FAL_API_KEY
  });
}

export async function generateVideo(
  imageUrl: string,
  prompt: string,
  modelType: 'seedance' | 'hailo' = 'seedance'
) {
  const model = modelType === 'seedance' 
    ? "fal-ai/fast-sdxl/image-to-video"  // ì‹¤ì œ ëª¨ë¸ëª… í™•ì¸ í•„ìš”
    : "fal-ai/hailo";
    
  const result = await fal.run(model, {
    input: {
      image_url: imageUrl,
      prompt: prompt,
      num_frames: 25,
      fps: 8,
      motion_strength: 0.7
    }
  });
  
  return result.video.url;
}
```

### ì˜ìƒ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸
```typescript
// app/api/canvas/generate/route.ts
export async function POST(request: Request) {
  const body = await request.json();
  
  // 1. DBì— ìƒì„± ìš”ì²­ ì €ì¥ (pending ìƒíƒœ)
  const generation = await saveGeneration(body);
  
  // 2. fal.ai ì§ì ‘ í˜¸ì¶œ (30-60ì´ˆ ì†Œìš”)
  try {
    const videoUrl = await generateWithFal(body);
    
    // 3. ì„±ê³µì‹œ DB ì—…ë°ì´íŠ¸
    await updateGeneration(generation.id, {
      status: 'completed',
      videoUrl
    });
    
    return Response.json({ 
      success: true, 
      generationId: generation.id,
      videoUrl 
    });
    
  } catch (error) {
    // 4. ì‹¤íŒ¨ì‹œ ì—ëŸ¬ ì²˜ë¦¬
    await updateGeneration(generation.id, {
      status: 'failed',
      error: error.message
    });
    
    return Response.json({ 
      success: false, 
      error: 'ì˜ìƒ ìƒì„± ì‹¤íŒ¨' 
    }, { status: 500 });
  }
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…
- video_generations í…Œì´ë¸” ì‚¬ìš©
- ìƒíƒœ: pending â†’ completed/failed
- ìµëª… ì‚¬ìš©ì ì§€ì› (user_id: 'anonymous')

### í™˜ê²½ë³€ìˆ˜
```
FAL_API_KEY=your_fal_api_key
DAILY_GENERATION_LIMIT=100
```

### Vercel ì„¤ì •
- í•¨ìˆ˜ íƒ€ì„ì•„ì›ƒ: 60ì´ˆ ì„¤ì • í•„ìš”
- vercel.jsonì— ì„¤ì • ì¶”ê°€

## Tasks / Subtasks

### Task 1: fal.ai í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (AC: 8)
- [x] @fal-ai/serverless-client íŒ¨í‚¤ì§€ ì„¤ì¹˜
- [x] lib/fal-ai.ts íŒŒì¼ ìƒì„±
- [x] fal.ai ì´ˆê¸°í™” ë° ì„¤ì •
- [x] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env.local)

### Task 2: ì˜ìƒ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (AC: 1, 2, 3)
- [x] app/api/canvas/generate/route.ts ìƒì„±
- [x] POST í•¸ë“¤ëŸ¬ êµ¬í˜„
- [x] íš¨ê³¼ í”„ë¡¬í”„íŠ¸ ê²°í•© ë¡œì§
- [x] fal.ai í˜¸ì¶œ í†µí•©

### Task 3: ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ (AC: 4, 7)
- [x] Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
- [x] video_generations í…Œì´ë¸” CRUD í•¨ìˆ˜
- [x] ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§
- [x] ì—ëŸ¬ ë¡œê¹… êµ¬í˜„

### Task 4: í´ë¼ì´ì–¸íŠ¸ í†µí•© (AC: 5)
- [x] Generate ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
- [x] API í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬
- [x] ìƒì„±ëœ ì˜ìƒ URL ìƒíƒœ ê´€ë¦¬
- [x] ImageSectionì— ì˜ìƒ í‘œì‹œ

### Task 5: íƒ€ì„ì•„ì›ƒ ë° ì—ëŸ¬ ì²˜ë¦¬ (AC: 6, 7)
- [x] Vercel í•¨ìˆ˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •
- [x] í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
- [x] ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì í‘œì‹œ
- [x] ì¬ì‹œë„ ì˜µì…˜ ì œê³µ

### Task 6: í…ŒìŠ¤íŠ¸ ë° ìµœì í™”
- [x] ë‹¤ì–‘í•œ ì´ë¯¸ì§€/í”„ë¡¬í”„íŠ¸ ì¡°í•© í…ŒìŠ¤íŠ¸
- [x] ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
- [x] ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- [x] ì¼ì¼ í•œë„ ì²´í¬ ë¡œì§ (ì„ íƒì‚¬í•­)

## Testing

### í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­
- fal.ai API ì—°ë™ í…ŒìŠ¤íŠ¸
- ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸
- íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- ì—ëŸ¬ í•¸ë“¤ë§ í…ŒìŠ¤íŠ¸
- í™˜ê²½ë³€ìˆ˜ ê²€ì¦

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. ì •ìƒì ì¸ ì˜ìƒ ìƒì„± í”Œë¡œìš°
2. fal.ai API ì—ëŸ¬ ì‘ë‹µ
3. ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ (60ì´ˆ ì´ˆê³¼)
4. ì˜ëª»ëœ ì´ë¯¸ì§€ URL ì „ë‹¬
5. ë¹ˆ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬

## Change Log
- [x] 2025-01-30: ì´ˆê¸° ìŠ¤í† ë¦¬ ìƒì„±
- [x] 2025-01-30: êµ¬í˜„ ì™„ë£Œ

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [x] Fallback: N/A

### Debug Log References
- [x] Session: 2025-01-30

### Completion Notes
- [x] fal.ai ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • ì™„ë£Œ
- [x] ì˜ìƒ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [x] ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ë° ìƒíƒœ ê´€ë¦¬ êµ¬í˜„
- [x] Generate ë²„íŠ¼ê³¼ ì˜ìƒ ìƒì„± í”Œë¡œìš° í†µí•©
- [x] Vercel í•¨ìˆ˜ íƒ€ì„ì•„ì›ƒ 60ì´ˆ ì„¤ì •
- [x] ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°± êµ¬í˜„
- [x] seedanceì™€ hailo ëª¨ë¸ ëª¨ë‘ ì§€ì› ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„

### File List
ì‹¤ì œ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼:
- [x] lib/fal-ai.ts (ìƒì„±)
- [x] app/api/canvas/generate/route.ts (ìƒì„±)
- [x] lib/db/video-generations.ts (ìƒì„±)
- [x] app/canvas/_components/QuickActionsBar.tsx (ìˆ˜ì •)
- [x] app/canvas/page.tsx (ì˜ìƒ ìƒì„± ë¡œì§ ì¶”ê°€)
- [x] app/canvas/_components/LeftPanel.tsx (props ì¶”ê°€)
- [x] vercel.json (ìƒì„±)
- [x] .env.local (ìˆ˜ì •)
- [x] types/canvas.ts (GeneratedVideo íƒ€ì… ì¶”ê°€)

## QA Results
- [x] ëª¨ë“  acceptance criteria ì¶©ì¡±
- [x] íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì»´íŒŒì¼ ì—ëŸ¬ ì—†ìŒ
- [x] ESLint ê²½ê³  í•´ê²°
- [x] ë¹Œë“œ ì„±ê³µ

## fal.ai API ì„¤ì • ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” ì œê³µëœ ë¸”ë£¨í”„ë¦°íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `fal.ai`ì˜ ë¹„ë””ì˜¤ ìƒì„± APIë¥¼ ì„¤ì •í•˜ê³  ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

-----

### ğŸš€ API ê¸°ë³¸ ì •ë³´

ë‘ ê°œì˜ ë‹¤ë¥¸ AI ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¡œë¶€í„° ë¹„ë””ì˜¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê° ëª¨ë¸ì€ ê³ ìœ í•œ ì—”ë“œí¬ì¸íŠ¸(URL) ì£¼ì†Œë¥¼ ê°€ì§‘ë‹ˆë‹¤.

  * **HTTP ë©”ì†Œë“œ:** ëª¨ë“  ìš”ì²­ì€ `POST` ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

  * **ì—”ë“œí¬ì¸íŠ¸:**

      * **seedance ëª¨ë¸:** `https://fal.run/fal-ai/bytedance/seedance/v1/pro/image-to-video`
      * **hailo ëª¨ë¸:** `https://fal.run/fal-ai/minimax/hailuo-02/standard/image-to-video`

-----

### ğŸ”‘ ì¸ì¦ ë° í—¤ë” ì„¤ì •

API ìš”ì²­ ì‹œì—ëŠ” **ì¸ì¦**ê³¼ **ì½˜í…ì¸  íƒ€ì…**ì„ ëª…ì‹œí•˜ê¸° ìœ„í•´ ì•„ë˜ ë‘ ê°€ì§€ í—¤ë”ë¥¼ í•„ìˆ˜ë¡œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

1.  **Authorization (ì¸ì¦)**

      * **Key:** `Authorization`
      * **Value:** `Key [YOUR_FAL_AI_API_KEY]`
      * **ì„¤ëª…:** `[YOUR_FAL_AI_API_KEY]` ë¶€ë¶„ì„ ìì‹ ì˜ fal.ai API í‚¤ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.

2.  **Content-Type (ì½˜í…ì¸  íƒ€ì…)**

      * **Key:** `Content-Type`
      * **Value:** `application/json`

-----

### ğŸ“¦ ìš”ì²­ ë³¸ë¬¸ (Request Body) êµ¬ì„±

ìš”ì²­ ë³¸ë¬¸ì€ **JSON í˜•ì‹**ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ê° ëª¨ë¸ë³„ë¡œ í•„ìš”í•œ íŒŒë¼ë¯¸í„°ê°€ ë‹¤ë¥´ë‹ˆ ì£¼ì˜ ê¹Šê²Œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

#### 1\. seedance ëª¨ë¸

  * **ì„¤ëª…:** `seedance` ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ 3ì´ˆ ê¸¸ì´ì˜ 1080p í•´ìƒë„ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤.
  * **ìš”ì²­ ë³¸ë¬¸ ì˜ˆì‹œ:**
    ```json
    {
      "prompt": "ì—¬ê¸°ì— í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "resolution": "1080p",
      "duration": "3",
      "image_url": "https://your-image-url.com/image.png"
    }
    ```

#### 2\. hailo ëª¨ë¸

  * **ì„¤ëª…:** `hailo` ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ 6ì´ˆ ê¸¸ì´ì˜ ì˜ìƒì„ ìƒì„±í•˜ë©°, í”„ë¡¬í”„íŠ¸ ìµœì í™” ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
  * **ìš”ì²­ ë³¸ë¬¸ ì˜ˆì‹œ:**
    ```json
    {
      "prompt": "ì—¬ê¸°ì— í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "image_url": "https://your-image-url.com/image.png",
      "duration": "6",
      "prompt_optimizer": true
    }
    ```