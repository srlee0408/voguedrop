# Story 2.7: 영상 생성 상태 관리 및 UI 업데이트

## Story

**As a** VogueDrop 사용자,
**I want** 영상 생성 진행 상황을 실시간으로 확인하고,
**so that** 생성 과정을 이해하고 결과를 즉시 확인할 수 있다.

## Status

Completed

## Acceptance Criteria

1. [x] Generate 버튼 클릭시 "Generating..." 상태가 표시됨
2. [x] 생성 중에는 Generate 버튼이 비활성화됨
3. [x] 생성 진행 중 로딩 애니메이션이 표시됨
4. [x] 생성 완료시 영상이 ImageSection에 자동으로 표시됨
5. [x] 최대 3개의 생성된 영상이 표시되며, 새 영상은 맨 앞에 추가됨
6. [x] 생성 실패시 에러 메시지가 토스트로 표시됨
7. [x] 생성 중 페이지를 벗어나려 할 때 경고 메시지가 표시됨

## Dev Notes

### 상태 관리 구조
```typescript
// Canvas 페이지 상태
const [isGenerating, setIsGenerating] = useState(false);
const [generatedVideos, setGeneratedVideos] = useState<GeneratedVideo[]>([]);
const [error, setError] = useState<string | null>(null);

interface GeneratedVideo {
  id: number;
  url: string;
  createdAt: Date;
  thumbnail?: string;
}
```

### 영상 생성 플로우
1. Generate 클릭 → isGenerating = true
2. API 호출 → 로딩 UI 표시
3. 응답 수신:
   - 성공: generatedVideos 배열 업데이트
   - 실패: 에러 토스트 표시
4. isGenerating = false

### ImageSection 업데이트
- 업로드된 이미지 + 생성된 영상들 표시
- 그리드 레이아웃: 1개 큰 영역 (현재 이미지/영상) + 3개 작은 영역 (히스토리)
- 클릭시 큰 영역에 표시

### 로딩 애니메이션
- Generate 버튼: 스피너 + "Generating..." 텍스트
- ImageSection: 오버레이 + 진행률 표시 (선택사항)
- 예상 시간 표시: "약 30-60초 소요"

### 페이지 이탈 방지
```typescript
useEffect(() => {
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (isGenerating) {
      e.preventDefault();
      e.returnValue = '';
    }
  };
  
  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [isGenerating]);
```

## Tasks / Subtasks

### Task 1: 상태 관리 구조 구현 (AC: 1, 2)
- [x] Canvas 페이지에 상태 변수 추가
- [x] 생성 상태에 따른 UI 업데이트 로직
- [x] Generate 버튼 상태 관리
- [x] 에러 상태 처리

### Task 2: 로딩 UI 구현 (AC: 3)
- [x] Generate 버튼 로딩 상태 UI
- [x] ImageSection 로딩 오버레이
- [x] 로딩 애니메이션 컴포넌트
- [x] 예상 시간 안내 텍스트

### Task 3: 영상 표시 로직 구현 (AC: 4, 5)
- [x] generatedVideos 배열 관리
- [x] 최대 3개 제한 로직
- [x] 새 영상 맨 앞 추가
- [x] ImageSection 영상 표시 UI 업데이트

### Task 4: 에러 처리 및 피드백 (AC: 6)
- [x] 에러 토스트 컴포넌트 통합
- [x] 에러 메시지 타입별 분류
- [x] 재시도 옵션 제공
- [x] 에러 로깅

### Task 5: 페이지 이탈 방지 (AC: 7)
- [x] beforeunload 이벤트 핸들러
- [x] 라우터 변경 감지 (Next.js)
- [x] 경고 모달 또는 브라우저 기본 경고
- [x] 생성 완료시 이벤트 제거

### Task 6: UI/UX 개선
- [x] 생성 성공시 성공 피드백
- [x] 영상 썸네일 생성 (선택사항)
- [x] 영상 호버시 미리보기
- [x] 생성 시간 표시

## Testing

### 테스트 요구사항
- 상태 변경에 따른 UI 업데이트 테스트
- 로딩 상태 표시 테스트
- 에러 처리 시나리오 테스트
- 페이지 이탈 방지 테스트
- 영상 목록 관리 테스트

### 테스트 시나리오
1. Generate 클릭 → 로딩 → 성공 플로우
2. Generate 클릭 → 로딩 → 실패 플로우
3. 3개 영상 생성 후 4번째 생성 (첫 번째 제거)
4. 생성 중 페이지 새로고침 시도
5. 네트워크 오류 시뮬레이션

## Change Log
- [x] 2025-01-30: 초기 스토리 생성
- [x] 2025-01-30: 구현 완료

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [x] Fallback: N/A

### Debug Log References
- [x] Session: 2025-01-30

### Completion Notes
- [x] 영상 생성 상태 관리 구현 완료
- [x] Generate 버튼 로딩 상태 및 비활성화 구현
- [x] GeneratingOverlay 컴포넌트로 로딩 애니메이션 구현
- [x] ImageSection에 생성된 영상 표시 및 썸네일 갤러리 구현
- [x] 최대 3개 영상 제한 및 FIFO 방식 관리
- [x] 에러 메시지 표시 및 5초 후 자동 제거
- [x] useBeforeUnload 훅으로 페이지 이탈 방지 구현
- [x] 영상 선택 및 미리보기 기능 추가

### File List
실제 생성/수정된 파일:
- [x] app/canvas/page.tsx (수정 - 상태 관리 및 에러 처리 추가)
- [x] app/canvas/_components/ImageSection.tsx (수정 - 영상 갤러리 UI 완전 재구현)
- [x] app/canvas/_components/QuickActionsBar.tsx (수정 - 로딩 상태 표시)
- [x] app/canvas/_components/GeneratingOverlay.tsx (생성)
- [x] app/canvas/_hooks/useBeforeUnload.ts (생성)
- [x] app/canvas/_components/LeftPanel.tsx (수정 - 에러 메시지 표시)

## QA Results
- [x] 모든 acceptance criteria 충족
- [x] 타입스크립트 컴파일 에러 없음
- [x] ESLint 경고 해결
- [x] 빌드 성공