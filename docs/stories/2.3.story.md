# Story 2.3: 이미지 업로드 API 및 UI 구현

## Story

**As a** VogueDrop 사용자,
**I want** Canvas 페이지에서 이미지를 업로드할 수 있고,
**so that** AI 영상 생성을 위한 원본 이미지를 제공할 수 있다.

## Status

Ready for Review

## Acceptance Criteria

1. [x] 이미지 드래그 앤 드롭 업로드가 가능함
2. [x] 클릭하여 파일 선택도 가능함
3. [x] JPG, PNG 형식만 허용되며, 다른 형식은 에러 메시지 표시
4. [x] 파일 크기는 10MB로 제한되며, 초과시 에러 메시지 표시
5. [x] 업로드 진행률이 표시됨
6. [x] 업로드된 이미지가 미리보기로 표시됨
7. [x] 이미지 업로드 API가 Supabase Storage를 사용함
8. [x] 업로드 실패시 적절한 에러 처리가 됨

## Dev Notes

### API 엔드포인트 구조 (MVP 문서 참조)
```typescript
// app/api/canvas/upload/route.ts
export async function POST(request: Request) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  // Supabase Storage에 직접 업로드
  const fileName = `${Date.now()}_${file.name}`;
  const { data, error } = await supabase.storage
    .from('media-asset')
    .upload(`temp/${fileName}`, file);
  
  // Public URL 반환
  const publicUrl = supabase.storage
    .from('media-asset')
    .getPublicUrl(`temp/${fileName}`).data.publicUrl;
  
  return Response.json({ url: publicUrl });
}
```

### ImageSection 컴포넌트 기능
- react-dropzone 라이브러리 사용 (또는 네이티브 구현)
- 업로드 상태: idle, uploading, success, error
- 이미지 미리보기 표시
- 업로드 진행률 표시 (ProgressBar 컴포넌트)

### 파일 유효성 검사
- 클라이언트: MIME 타입 확인 (image/jpeg, image/png)
- 클라이언트: 파일 크기 확인 (10MB)
- 서버: 추가 보안 검증

### Supabase Storage 설정
- 버킷: 'media-asset' (기존 버킷 사용)
- 경로: 'temp/' 폴더 사용 (임시 업로드용)
- 정리: 추후 크론잡으로 오래된 임시 파일 삭제

### 에러 메시지
```typescript
const ERROR_MESSAGES = {
  INVALID_FORMAT: 'JPG, PNG 형식만 지원됩니다.',
  FILE_TOO_LARGE: '파일 크기는 10MB 이하여야 합니다.',
  UPLOAD_FAILED: '이미지 업로드에 실패했습니다. 다시 시도해주세요.',
  NETWORK_ERROR: '네트워크 연결을 확인해주세요.'
};
```

## Tasks / Subtasks

### Task 1: 이미지 업로드 API 구현 (AC: 7)
- [x] `app/api/canvas/upload/route.ts` 파일 생성
- [x] POST 핸들러 구현
- [x] Supabase Storage 연동
- [x] 파일 검증 로직 추가
- [x] 에러 핸들링 구현

### Task 2: ImageSection UI 구현 (AC: 1, 2, 6)
- [x] ImageSection 컴포넌트 업데이트
- [x] 드래그 앤 드롭 영역 구현
- [x] 파일 선택 input 구현
- [x] 이미지 미리보기 기능 구현
- [x] 업로드 영역 스타일링

### Task 3: 파일 유효성 검사 구현 (AC: 3, 4)
- [x] 클라이언트 사이드 파일 타입 검증
- [x] 클라이언트 사이드 파일 크기 검증
- [x] 서버 사이드 추가 검증
- [x] 에러 메시지 표시 UI

### Task 4: 업로드 진행률 표시 (AC: 5)
- [x] ProgressBar 컴포넌트 생성 또는 기존 사용
- [x] 업로드 진행률 계산 로직
- [x] 업로드 중 UI 상태 표시
- [ ] 취소 기능 구현 (선택사항)

### Task 5: 에러 처리 및 상태 관리 (AC: 8)
- [x] 업로드 상태 관리 (useState)
- [x] 에러 상태 처리
- [ ] 재시도 기능 구현
- [x] 토스트 또는 에러 메시지 표시

### Task 6: 통합 테스트
- [x] 다양한 파일 형식 테스트
- [x] 대용량 파일 테스트
- [x] 네트워크 에러 시뮬레이션
- [x] 동시 업로드 방지 테스트

## Testing

### 테스트 요구사항
- 파일 업로드 API 유닛 테스트
- 파일 유효성 검사 테스트
- 드래그 앤 드롭 기능 테스트
- 에러 처리 시나리오 테스트
- Supabase Storage 연동 테스트

### 테스트 케이스
1. 정상적인 JPG/PNG 파일 업로드
2. 잘못된 파일 형식 업로드 시도
3. 10MB 초과 파일 업로드 시도
4. 네트워크 연결 끊김 시나리오
5. 동시 다중 업로드 방지

## Change Log
- [x] 2025-01-30: 초기 스토리 생성
- [x] 2025-01-30: 스토리 구현 완료

## Dev Agent Record

### Agent Model Used
- [x] Primary: Claude 3.5 Sonnet
- [ ] Fallback: N/A

### Debug Log References
- [x] Session: 2025-01-30

### Completion Notes
- [x] 이미지 업로드 API 구현 완료
- [x] 드래그 앤 드롭 및 클릭 업로드 기능 구현
- [x] 파일 검증 (타입, 크기) 구현
- [x] 업로드 진행률 표시 구현
- [x] 에러 처리 및 메시지 표시 구현
- [x] Supabase Storage 연동 성공

### File List
예상 생성/수정 파일:
- [x] app/api/canvas/upload/route.ts
- [x] app/canvas/_components/ImageSection.tsx (수정)
- [x] lib/constants/errors.ts (생성 또는 추가)
- [x] app/canvas/_components/LeftPanel.tsx (수정)
- [x] app/canvas/page.tsx (수정)
- [x] types/canvas.ts (생성)

## QA Results
- [ ] TBD